# 02. Микросервисы: принципы

_Вы работаете в крупной компанию, которая строит систему на основе микросервисной архитектуры. 
Вам как DevOps специалисту необходимо выдвинуть предложение по организации инфраструктуры, для разработки и эксплуатации._

## Задача 1: API Gateway

| Решение                                                                 | Маршрутизация | Аутентификация   | Терминация HTTPS |
|-------------------------------------------------------------------------|---------------|------------------|------------------|
| [nginx](https://nginx.org/)                                             | +             | + (basic/digest) | +                |
| [haproxy](http://www.haproxy.org/)                                      | +             | + (jwt/oauth)    | +                |
| [traefik](https://doc.traefik.io/traefik/)                              | +             | + (plugins)      | +                |
| [kong](https://docs.konghq.com/gateway/latest/)                         | +             | + (many)         | +                |
| [Tyk.io](https://tyk.io/docs/)                                          | +             | + (many)         | +                |
| [Apache APISIX](https://apisix.apache.org/docs/apisix/getting-started/) | +             | + (many)         | +                |
| [KrakenD](https://www.krakend.io/docs/)                                 | +             | + (many)         | +                |

В целом, для построения api gateway с некоторыми ограничениями может быть использован любой популярный reverse proxy / балансировщик нагрузки, 
либо же специализированные пакеты. 
Поскольку подробности о сложности/нагруженности/размещении системы неизвестны, наверное стоит остановить выбор на продуктах "начального" уровня, таких как 
`traefik` либо `kong`. Оба выпускаются под свободной лицензией. Первый ориентирован на работу в контейнерах как ingress proxy, быстр, Go-based, расширяется плагинами. 
Второй - именно как api gateway, более гибок и имеет более специфические инструменты (web-панель, мониторинг, аудит). Под капотом - всем известный nginx+lua.

## Задача 2: Брокер сообщений

|                                                       | RabbitMQ          | Apache Kafka   | Apache ActiveMQ            | NATS                  | Redis |
|-------------------------------------------------------|-------------------|----------------|----------------------------|-----------------------|-------|
| Поддержка кластеризации для обеспечения надежности    | +                 | +              | +                          | +                     | +     |
| Хранение сообщений на диске в процессе доставки       | +                 | +              | +                          | + (JetStream enabled) | +-    |
| Высокая скорость работы                               | +                 | +              | +                          | +                     | +     |
| Форматы сообщений / протоколы                         | AMQP, MQTT, STOMP | Произвольный   | AMQP, AUTO, MQTT, REST,... | NATS, WebSocket,MQTT  | RESP  |
| Разделение прав доступа к различным потокам сообщений | +                 | +              | +                          | +                     | +     |
| Простота эксплуатации                                 | +                 | -              | -                          | +                     | +     |

Выбор брокера также зависит от сложности и нагруженности системы. 
Не зная характера задачи, сложно выбрать конкретный вариант.
- Если планируется очень сильная нагрузка и большие объёмы данных, то стоит склониться к выбору kafka, приняв сложность настройки и эксплуатации.
- Если важна быстрота запуска вероятен выбор RabbitMQ, как наиболее популярного.
- Насколько реально важна универсальность в поддерживаемых протоколах? Планируется ли подключение сторонних систем или нужно только внутреннее взаимодействие между сервисами?
Может, достаточно будет и Redis.
- Есть ли ограничения по ресурсам? Может, тяжёлые java-приложения не подойдут и выбор стоит сделать в пользу лёгкого и быстрого NATS.